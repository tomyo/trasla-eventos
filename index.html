<!DOCTYPE html>
<html lang="es-AR">
  <head>
    <meta name="theme-color" content="#303030" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eventos en Trasla</title>
    <meta
      name="description"
      content="Eventos en Traslasierra, C√≥rdoba, Argentina"
    />
    <script type="module" src="/components/event-entry.js"></script>
    <script type="module" src="/components/theme-toggle.js"></script>
    <script type="module" src="/components/events-filter.js"></script>
    <link rel="manifest" href="manifest.json" />

    <style>
      /* Reset */
      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        font-size: 100%;
        line-height: 1.25;
        scroll-behavior: smooth;
      }

      details summary {
        cursor: pointer;
      }

      details summary > * {
        display: inline;
      }

      /* Global styles */

      /* <theme> */
      [data-theme="üåë"] {
        --color-scheme: dark;
        color-scheme: dark;
      }

      [data-theme="‚òÄÔ∏è"] {
        --color-scheme: light;
        color-scheme: light;
      }

      :root {
        --color-light: #fafafa;
        --color-dark: #222222;
        --color: var(--color-dark);
        --background-color: var(--color-light);
        color-scheme: var(--color-scheme, dark light);

        &[data-theme="üåë"] {
          color-scheme: dark;

          --color: var(--color-light);
          --background-color: var(--color-dark);
        }
      }
      /* </theme> */

      @font-face {
        font-family: "DM Sans";
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url("/assets/fonts/DM-Sans.woff2") format("woff2");
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6,
          U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC,
          U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

      body {
        font-family: "DM Sans", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
          "Helvetica Neue", sans-serif;
        background-color: var(--background-color);
        color: var(--color);

        transition: all ease-in-out 0.2s;
      }

      a {
        color: inherit;
      }

      button,
      .button {
        outline: 1px solid currentColor;
        text-decoration: none;
        padding: 0.7rem 1.5rem;
        border-radius: 2rem;
        text-transform: uppercase;

        &:hover,
        &:focus-within {
          background-color: color-mix(in srgb, currentColor 10%, transparent);
        }
      }
    </style>
  </head>
  <body>
    <theme-toggle title="Alternar color del tema">
      <img
        src="/assets/images/theme-toggle.png"
        width="25"
        height="25"
        alt="Sol/Luna: Alternar color del tema"
      />
    </theme-toggle>
    <main>
      <section id="hero">
        <!-- <picture>
          <source
            srcset="/assets/images/portada-landscape-2048w.avif"
            type="image/avif"
            media="(orientation: landscape)"
          />
          <source
            srcset="/assets/images/portada-landscape-2048w.jpg"
            type="image/jpeg"
            media="(orientation: landscape)"
          />
          <source
            srcset="/assets/images/portada-portrait-600w.avif"
            type="image/avif"
            media="(orientation: portrait)"
          />
          <img
            id="bgImage"
            src="/assets/images/portada-portrait-600w.jpg"
            type="image/jpeg"
            media="(orientation: portrait)"
            alt=""
          />
          <style>
            #bgImage {
              position: absolute;
              inset: 0;
              width: 100%;
              height: 100%;
              z-index: -1;
              object-fit: cover;
              object-position: center;
            }
          </style>
        </picture> -->
        <a href="/" style="text-decoration: none">
          <h1>EVENTOS.TRASLA</h1>
        </a>

        <div id="actions">
          <a
            id="addEvent"
            class="button"
            target="_blank"
            title="Publicar nuevo evento"
            href="https://docs.google.com/forms/d/e/1FAIpQLSdxTx6-LxssWkFlbPqFF6u-QZrNpgC-RJpm9eNweFHXNY8bVA/viewform?usp=sf_link"
          >
            Publicar evento
          </a>
          <a class="button" title="Ver eventos" href="#events">Ver eventos</a>
        </div>
      </section>
      <section id="events">
        <events-filter>
          <details>
            <summary>
              <h5>Filtrar por</h5>
            </summary>
            <form>
              <label
                >Lugar
                <select name="locality">
                  <option value="" default>Todos</option>
                  <option value="Arroyo de Los Patos">
                    Arroyo de Los Patos
                  </option>
                  <option value="Boca del Rio">Boca del Rio</option>
                  <option value="Dique de La Vi√±a">Dique de La Vi√±a</option>
                  <option value="El Pueblito">El Pueblito</option>
                  <option value="La Paz">La Paz</option>
                  <option value="La Poblaci√≥n">La Poblaci√≥n</option>
                  <option value="Las Calles">Las Calles</option>
                  <option value="Las Chacras">Las Chacras</option>
                  <option value="Las Rabonas">Las Rabonas</option>
                  <option value="Las Tapias">Las Tapias</option>
                  <option value="Los Hornillos">Los Hornillos</option>
                  <option value="Los Molles">Los Molles</option>
                  <option value="Los Pozos">Los Pozos</option>
                  <option value="Luyaba">Luyaba</option>
                  <option value="Mina Clavero">Mina Clavero</option>
                  <option value="Nono">Nono</option>
                  <option value="Panaholma">Panaholma</option>
                  <option value="Piedra Pintada">Piedra Pintada</option>
                  <option value="San Huberto">San Huberto</option>
                  <option value="San Javier">San Javier</option>
                  <option value="San Lorenzo">San Lorenzo</option>
                  <option value="San Pedro">San Pedro</option>
                  <option value="Travesia">Travesia</option>
                  <option value="Villa Cura Brochero">
                    Villa Cura Brochero
                  </option>
                  <option value="Villa de Las Rosas">Villa de Las Rosas</option>
                  <option value="Villa Dolores">Villa Dolores</option>
                  <option value="Yacanto">Yacanto</option>
                </select>
              </label>
              <label>
                A partir del
                <input type="date" name="startDate" />

                <script>
                  // Set date to today by default (if empty)
                  const dateInput = document.querySelector(
                    "events-filter [name=startDate]"
                  );
                  if (dateInput.value == "") {
                    const formattedDate = new Date()
                      .toISOString()
                      .split("T")[0];
                    dateInput.value = formattedDate;
                  }
                </script>
              </label>
            </form>
          </details>
          <style>
            events-filter {
              text-wrap: balance;

              details {
                line-height: 2;

                summary {
                  text-align: center;
                  margin-block-end: 0.5rem;
                }
              }
            }
          </style>
          <event-entries>
            <p style="text-align: center">¬∑ ¬∑ ¬∑</p>
          </event-entries>
        </events-filter>
      </section>
    </main>

    <style>
      :root {
        &[data-theme="üåë"] {
          theme-toggle {
            filter: invert(1);
          }
        }
      }

      theme-toggle {
        position: absolute;
        cursor: pointer;
        top: max(1.5rem, 5vmin);
        left: max(1.5rem, 7vmin);
        visibility: hidden;
      }

      main {
        max-width: 37ch;
        margin: auto;
        display: flex;
        flex-flow: column;

        section {
          padding-block: 2rem;
        }

        section#hero {
          display: flex;
          flex-flow: column;
          justify-content: space-between;
          text-align: center;
          padding-block: 5rem;
          height: 100vh;
          height: 100lvh;

          color: var(--color-light);

          &::before {
            content: "";
            position: absolute;
            inset: 0;
            z-index: -1;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            background-image: url("/assets/images/portada-portrait-600w.avif");
            background-image: image-set(
              url("/assets/images/portada-portrait-600w.avif") 1x
                type("image/avif"),
              url("/assets/images/portada-portrait-600w.jpg") 1x
                type("image/jpeg")
            );
          }

          @media (orientation: landscape) {
            &::before {
              background-image: url("/assets/images/portada-landscape-2048w.avif");
              background-image: image-set(
                url("/assets/images/portada-landscape-2048w.avif") 1x
                  type("image/avif"),
                url("/assets/images/portada-landscape-2048w.jpg") 1x
                  type("image/jpeg")
              );
            }
          }

          #actions {
            display: grid;
            justify-content: center;
            gap: 1rem;
            text-align: center;
          }

          h1 {
            font-weight: 300;
            margin-bottom: 0.4rem;
            letter-spacing: 1px;
          }
        }
      }

      section#events {
        events-filter form {
          text-align: center;
          display: grid;
          justify-items: start;
          width: max-content;
          margin: auto;
        }

        event-entries {
          display: flex;
          flex-flow: column nowrap;
          max-width: 90ch;
          margin-inline: auto;
          gap: 1rem;

          event-entry {
            --visible-elements: 1;
            --padding: 4.5rem 1rem;
            margin: 2rem 2rem;
            border-radius: 10px;
            min-width: min-content;
            text-align: center;
            background-image: linear-gradient(
              to bottom,
              transparent,
              color-mix(in srgb, var(--color, currentcolor) 7%, transparent)
            );
            padding: 1.5rem;
            background-color: color-mix(
              in srgb,
              var(--color, currentcolor) 7%,
              var(--background-color, currentcolor)
            );

            .event-image {
              width: 100%;
              height: auto;
              min-height: 15rem;
              object-fit: contain;
              cursor: pointer;
              border-radius: 10px;
            }

            .info {
              display: grid;
              justify-content: center;
              gap: 0.5rem;
              margin-bottom: 1em;

              svg {
                color: color-mix(in srgb, currentColor 60%, transparent);
              }

              input[type="date"] {
                -webkit-appearance: none; /* Remove arrow in chrome mobile */
                background: transparent;
                width: min-content;
                border: none;
                padding: 0;

                font-family: inherit;
                font-size: inherit;
                color: inherit;

                &:disabled {
                  /* Allow click on parent to toggle details open/close */
                  pointer-events: none;
                }
              }

              p {
                margin: var(--margin);
              }
            }

            summary {
              align-items: center;
              cursor: pointer;
              padding-block: 0.5rem;
              align-items: start;
              position: relative;

              &::-webkit-details-marker {
                display: none;
              }
            }

            [part="description"] {
              word-break: break-word;
              text-wrap: balance;
              text-align: start;
            }

            [part="buttons"] {
              display: flex;
              justify-content: space-evenly;
              margin-block: 1rem;
            }

            [part="button"] {
              display: inline-block;
              border-radius: 2px;
              text-decoration: none;
              cursor: pointer;
              transition-duration: 0.2s;
              padding: 0.5rem;
              height: 2.5rem;
              border: none;
              background: none;
              outline: none;

              &:hover {
                background-color: color-mix(
                  in srgb,
                  var(--color, currentColor) 10%,
                  transparent
                );
              }
            }
          }
        }
      }

      /* css support warning */
      @supports not selector(&) {
        body::before {
          content: "üö® El sitio requiere de una versi√≥n mas actualizada del navegador.";
          display: block;
          position: sticky;
          top: 0;
          color: red;
          font-size: 1.5rem;
          text-align: center;
          padding: 1rem;
        }
      }
    </style>

    <script type="module">
      import { getSheetData } from "/lib/get-gsheet-data.js";
      import {
        escapeHtml,
        slugify,
        encodeForDataset,
        formatEventResponse,
        parseEventResponseDateString,
      } from "/lib/utils.js";

      function isDateToday(date) {
        return (
          date.getDate() === now.getDate() &&
          date.getMonth() === now.getMonth() &&
          date.getFullYear() === now.getFullYear()
        );
      }

      /**
       *
       * @param {Date} date
       * @returns
       */
      function getSortOrder(date) {
        const items = [
          date.getFullYear(),
          date.getMonth(),
          date.getDate(),
          date.getHours(),
        ];
        return items.map((t) => t.toString().padStart(2, "0")).join("");
      }

      function appendEvents(events) {
        for (const event of events) {
          const eventDate = parseEventResponseDateString(event["Comienzo"]);
          if (!isDateToday(eventDate) && eventDate < now) {
            continue;
          }

          appendEvent(event);
        }
      }

      /**
       * @param {EventResponse} event
       */
      function appendEvent(eventResponse, { open, order } = {}) {
        const eventData = formatEventResponse(eventResponse);
        const eventElement = document.createElement("event-entry");

        if (!order) {
          order = getSortOrder(new Date(eventData["start-date"]));
        }
        for (const [key, value] of Object.entries(eventData)) {
          if (!Object.hasOwnProperty.call(eventData, key)) continue;
          if (typeof value !== "string")
            console.error(`Value for key ${key} is not a string: ${value}`);

          eventElement.setAttribute(`data-${key}`, escapeHtml(value));
        }

        if (open) {
          eventElement.open = true;
        }
        eventElement.style = `order: ${order}`;
        eventsElement.appendChild(eventElement);
      }

      async function showEvents(events) {
        // Fuzzy search
        const url = new URL(location);
        const query = url.searchParams.get("q") || "";
        let eventsToAppend = [];
        eventsElement.innerHTML = ""; /* Clear loading message */

        if (query) {
          const { fuzzySearch } = await import("/lib/fuzzy-search-events.js");

          const searchResults = fuzzySearch(events, query);
          if (!searchResults) {
            eventsElement.innerHTML = /*html*/ `<p>No encontramos resultados con: ${query}</p>`; /* Clear loading message */
            return;
          }
          return appendEvent(searchResults[0].item, { open: true });
        }

        appendEvents(events);
      }

      // RUN

      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const eventsElement = document.querySelector("event-entries");

      // Get all events and drop old ones
      const upcomingEvents = (await getSheetData()).filter((event) => {
        return today <= parseEventResponseDateString(event["Comienzo"]);
      });

      if (!document.querySelector("#events event-entry")) {
        showEvents(upcomingEvents);
      }
    </script>
  </body>
</html>
