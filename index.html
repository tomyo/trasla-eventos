<!DOCTYPE html>
<html lang="es-AR">
  <head>
    <meta name="theme-color" content="#303030" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Eventos en Traslasierra, C√≥rdoba, Argentina"
    />
    <script type="module" src="/components/event-entry.js"></script>
    <script type="module" src="/components/theme-toggle.js"></script>
    <link rel="manifest" href="manifest.json" />
    <title>Eventos en Trasla</title>

    <style>
      /* Reset */
      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        font-size: 100%;
        line-height: 1.25;
        scroll-behavior: smooth;
      }

      details summary {
        cursor: pointer;
      }

      details summary > * {
        display: inline;
      }

      /* Global styles */

      /* <theme> */
      [data-theme="üåë"] {
        --color-scheme: dark;
        color-scheme: dark;
      }

      [data-theme="‚òÄÔ∏è"] {
        --color-scheme: light;
        color-scheme: light;
      }

      :root {
        --brand-color: #303030;
        --color: #222222;
        --background-color: color-mix(in srgb, var(--brand-color) 15%, white);
        color-scheme: var(--color-scheme, dark light);

        &[data-theme="üåë"] {
          color-scheme: dark;

          --color: #f5f5f5;
          --background-color: var(--brand-color);
        }
      }
      /* </theme> */

      @font-face {
        font-family: "Objective";
        src: url("/assets/fonts/Objective-Regular.woff2") format("woff2");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }

      body {
        font-family: Objective, system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
          "Helvetica Neue", sans-serif;
        background-color: var(--background-color);
        color: var(--color);

        transition: all ease-in-out 0.2s;
      }

      a {
        color: inherit;
      }
    </style>
  </head>
  <body>
    <header>
      <theme-toggle title="Alternar color del tema">
        <img
          src="/assets/images/theme-toggle.png"
          width="25px"
          height="25px"
          alt="Sol/Luna: Alternar color del tema"
        />
      </theme-toggle>
      <a href="/" style="text-decoration: none"><h2>EVENTOS.TRASLA</h2></a>
      <a
        id="addEvent"
        target="_blank"
        title="Publicar nuevo evento"
        href="https://docs.google.com/forms/d/e/1FAIpQLSdxTx6-LxssWkFlbPqFF6u-QZrNpgC-RJpm9eNweFHXNY8bVA/viewform?usp=sf_link"
      >
        <svg
          width="25px"
          height="25px"
          viewBox="0 0 24 24"
          fill="none"
          stroke="var(--color, currentColor)"
          xmlns="http://www.w3.org/2000/svg"
        >
          <circle cx="12" cy="12" r="10" stroke-width="1.5" />
          <path
            d="M15 12h-3m0 0H9m3 0V9m0 3v3"
            stroke-width="1.5"
            stroke-linecap="round"
          />
        </svg>
      </a>
    </header>
    <main>
      <section id="events">
        <p style="text-align: center">¬∑ üåº ¬∑</p>
      </section>
    </main>

    <style>
      :root[data-theme="üåë"] {
        #logo,
        theme-toggle {
          filter: invert(1);
        }
      }

      header {
        text-align: center;
        padding: 2rem; /* margin adds scroll */
        padding-top: 3.3rem;

        theme-toggle {
          position: absolute;
          cursor: pointer;
          top: max(1.5rem, 5vmin);
          left: max(1.5rem, 7vmin);
        }
        #addEvent {
          position: absolute;
          top: max(1.5rem, 5vmin);
          right: max(1.5rem, 7vmin);
          width: min-content;
          text-decoration: none;
          color: var(--color, currentColor);
        }

        h2 {
          font-weight: 400;
          margin-bottom: 0.4rem;
        }
      }

      main {
        max-width: 37ch;
        margin: auto;
      }

      #events {
        display: flex;
        flex-flow: column nowrap;
        max-width: 90ch;
        margin-inline: auto;
        gap: 1rem;

        event-entry {
          --visible-elements: 1;
          --padding: 0.5rem 1rem;
          display: block;
          padding: 1rem;
          border-radius: 2px;
          min-width: min-content;
          text-align: center; /* Center CTA button */

          background-image: linear-gradient(
            to bottom,
            transparent,
            color-mix(in srgb, var(--color, currentcolor) 7%, transparent)
          );

          .event-image {
            width: 100%;
            height: auto;
            min-height: 15rem;
            object-fit: contain;
            cursor: pointer;
          }

          summary {
            align-items: center;
            cursor: pointer;
            margin-block: 0.5rem;
            align-items: start;
            position: relative;

            .info {
              display: inline-flex;
              align-items: center;
              justify-content: space-between;
              gap: 0.5rem;
              width: calc(100% - 3ch); /* 3ch for the arrow */

              .location,
              .datetime {
                display: flex;
                gap: 0.5rem;
              }

              svg {
                color: color-mix(in srgb, currentColor 60%, transparent);
              }

              input[type="date"] {
                -webkit-appearance: none; /* Remove arrow in chrome mobile */
                background: transparent;
                width: min-content;
                border: none;
                padding: 0;

                font-family: inherit;
                font-size: inherit;
                color: inherit;

                &:disabled {
                  /* Allow click on parent to toggle details open/close */
                  pointer-events: none;
                }
              }

              p {
                --margin: 0 2px; /* match input date */
                text-align: center;
                margin: var(--margin);
              }
            }

            &::-webkit-details-marker {
              display: none;
            }
          }

          [part="description"] {
            word-break: break-word;
            text-wrap: balance;
            text-align: start;
            margin-inline: 1rem;
          }

          [part="buttons"] {
            display: flex;
            justify-content: space-evenly;
            margin-block: 2rem 1rem;
          }

          [part="button"] {
            display: inline-block;
            border-radius: 2px;
            text-decoration: none;
            cursor: pointer;
            transition-duration: 0.2s;
            padding: 0.5rem;
            height: 2.5rem;

            &:hover {
              background-color: color-mix(
                in srgb,
                var(--color, currentColor) 10%,
                transparent
              );
            }
          }
        }
      }

      /* css support warning */
      @supports not selector(&) {
        main::after {
          content: "üö® Este sitio por ahora requiere de una versi√≥n mas actualizada de tu navegador...";
          display: block;
          color: red;
          font-size: 1.5rem;
          text-align: center;
        }
      }
    </style>
  </body>

  <script type="module">
    import { getSheetData } from "/get-gsheet-data.js";

    function isDateToday(date) {
      return (
        date.getDate() === now.getDate() &&
        date.getMonth() === now.getMonth() &&
        date.getFullYear() === now.getFullYear()
      );
    }

    /**
     *
     * @param {Date} date
     * @returns
     */
    function getSortOrder(date) {
      const items = [
        date.getFullYear(),
        date.getMonth(),
        date.getDate(),
        date.getHours(),
      ];
      return items.map((t) => t.toString().padStart(2, "0")).join("");
    }
    /**
     *
     * @param {String} dateString
     * @returns {Date}
     *
     * Format expected: "dd/mm/yyyy hh:mm:ss"
     */
    function parseDateString(dateString) {
      const [date, time] = dateString.split(" ");
      const [day, month, year] = date.split("/");
      const [hour, minute] = time.split(":");
      return new Date(year, month - 1, day, hour, minute);
    }

    document.querySelectorAll("summary").forEach((summary) => {
      summary.addEventListener("click", (event) => {
        setTimeout(
          () =>
            summary.nextElementSibling.scrollIntoView({
              block: "nearest",
              behavior: "smooth",
            }),
          100
        );
      });
    });

    function appendEvents(events) {
      for (const event of events) {
        const eventDate = parseDateString(event["Comienzo"]);
        if (!isDateToday(eventDate) && eventDate < now) {
          // console.info("Omitting old event:", event["Comienzo"]);
          continue;
        }

        // console.info("Event to display received:", event);
        appendEvent(event);
      }
    }

    /**
     * @param {EventData} event
     */
    function appendEvent(event, { open, order } = {}) {
      const eventElement = document.createElement("event-entry");
      if (!order) {
        order = getSortOrder(parseDateString(event["Comienzo"]));
      }
      eventElement.data = event;
      if (open) {
        eventElement.open = true;
      }
      eventElement.style = `order: ${order}`;
      eventsElement.appendChild(eventElement);
    }

    async function showEvents(events) {
      // Fuzzy search
      const url = new URL(location);
      const query = url.searchParams.get("q") || "";
      let eventsToAppend = [];

      if (query) {
        const Fuse = (await import("/assets/js/fuse.v7.0.0.mjs")).default;
        const fuse = new Fuse(events, {
          keys: ["Descripci√≥n", "Comienzo", "Localidad", "T√≠tulo", "Instagram"],
          includeScore: true,
          ignoreLocation: true,
          threshold: 0.7, // 0 full strict, 1 full relax
        });

        const searchResults = fuse.search(query);
        if (!searchResults) {
          eventsElement.innerHTML =
            "No encontramos nada con: " + query; /* Clear loading message */
          return;
        }
        const sortedResults = searchResults.sort((a, b) => a.score - b.score);
        const event = sortedResults[0].item;
        return appendEvent(event, { open: true });
      }

      eventsElement.innerHTML = ""; /* Clear loading message */
      appendEvents(events);
    }

    // RUN

    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const eventsElement = document.getElementById("events");

    // Get all events and drop old ones
    const upcomingEvents = (await getSheetData()).filter((event) => {
      return today <= parseDateString(event["Comienzo"]);
    });

    showEvents(upcomingEvents);
  </script>
</html>
