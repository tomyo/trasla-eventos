<!DOCTYPE html>
<html lang="es-AR" id="root">
  <head>
    <meta name="theme-color" content="#303030" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Eventos en Traslasierra, C√≥rdoba, Argentina"
    />
    <script type="module" src="/components/event-entry.js"></script>
    <script type="module" src="/components/theme-toggle.js"></script>
    <link rel="manifest" href="manifest.json" />
    <title>Eventos en Trasla</title>

    <style>
      /* Reset */
      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        height: 100%;
        min-height: 100%;
        font-size: 100%;
        line-height: 1.25;
        scroll-behavior: smooth;
      }

      /* Global styles */

      /* <theme> */
      [data-theme="üåë"] {
        --color-scheme: dark;
        color-scheme: dark;
      }

      [data-theme="‚òÄÔ∏è"] {
        --color-scheme: light;
        color-scheme: light;
      }

      :root {
        --brand-color: #303030;
        --color: #222222;
        --background-color: color-mix(in srgb, var(--brand-color) 15%, white);
        color-scheme: var(--color-scheme, dark light);

        &[data-theme="üåë"] {
          color-scheme: dark;

          --color: #f5f5f5;
          --background-color: var(--brand-color);
        }
      }
      /* </theme> */

      @font-face {
        font-family: "Objective";
        src: url("/assets/fonts/Objective-Regular.woff2") format("woff2");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }

      body {
        font-family: Objective, system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
          "Helvetica Neue", sans-serif;
        background-color: var(--background-color);
        color: var(--color);

        transition: all ease-in-out 0.2s;
      }

      a {
        color: inherit;
      }
    </style>
  </head>
  <body>
    <header>
      <theme-toggle>
        <img
          src="/assets/images/theme-toggle.png"
          width="25px"
          height="25px"
          alt="Cambiar color del tema"
        />
      </theme-toggle>
      <h2 style="font-weight: 400; margin-bottom: 0.4rem">EVENTOS EN TRASLA</h2>
      <a
        id="addEvent"
        target="_blank"
        href="https://docs.google.com/forms/d/e/1FAIpQLSdxTx6-LxssWkFlbPqFF6u-QZrNpgC-RJpm9eNweFHXNY8bVA/viewform?usp=sf_link"
      >
        <svg
          width="25px"
          height="25px"
          viewBox="0 0 24 24"
          fill="none"
          stroke="var(--color, currentColor)"
          xmlns="http://www.w3.org/2000/svg"
        >
          <circle cx="12" cy="12" r="10" stroke-width="1.5" />
          <path
            d="M15 12h-3m0 0H9m3 0V9m0 3v3"
            stroke-width="1.5"
            stroke-linecap="round"
          />
        </svg>
      </a>
    </header>
    <main>
      <section id="events">
        <p style="text-align: center">...</p>
      </section>
    </main>

    <style>
      :root[data-theme="üåë"] {
        #logo,
        theme-toggle {
          filter: invert(1);
        }
      }

      header {
        text-align: center;
        padding: 2rem; /* margin adds scroll */
        padding-top: 3.3rem;

        theme-toggle {
          position: absolute;
          cursor: pointer;
          top: max(1.5rem, 5vmin);
          left: max(1.5rem, 7vmin);
        }
        #addEvent {
          position: absolute;
          top: max(1.5rem, 5vmin);
          right: max(1.5rem, 7vmin);
          width: min-content;
          text-decoration: none;
          color: var(--color, currentColor);
        }

        h2 {
          line-height: 1.5;
          text-decoration: underline;
          text-underline-offset: 0.55rem;
        }
      }

      main {
        max-width: 37ch;
        margin: auto;
      }

      #events {
        display: flex;
        flex-flow: column nowrap;
        max-width: 90ch;
        margin-inline: auto;

        event-entry:hover,
        event-entry[open] {
          background-color: color-mix(
            in srgb,
            var(--color, currentcolor) 7%,
            transparent
          );
          transition-duration: 0.2s;
        }

        event-entry {
          --visible-elements: 1;
          --padding: 0.5rem 1rem;
          display: block;
          padding: var(--padding);
          margin: 1rem;
          border-radius: 0.5rem;
          min-width: min-content;
          text-align: center; /* Center CTA button */
          box-shadow: color-mix(
              in srgb,
              var(--color, currentcolor),
              transparent
            )
            0px 0px 0.3rem;

          @media (640px < width) {
            --visible-elements: 1;
            --padding: 1rem;

            summary {
              /* Show a row instead of a column of elements */
              --grid-template: 1fr / repeat(var(--visible-elements), 1fr);
              --row-gap: 2rem;
            }
          }

          summary {
            --row-gap: 1rem;
            --grid-template: repeat(var(--visible-elements), 1fr) / 1fr;

            display: grid;
            grid-template: var(--grid-template);
            align-items: center;
            gap: var(--row-gap) 1rem;
            cursor: pointer;
            margin-block: 1rem;
            align-items: start;
            position: relative;

            .event-image {
              width: 100%;
              min-height: 15rem;
              object-fit: contain;
            }

            .location,
            .datetime {
              display: flex;
              gap: 0.5rem;
            }

            > * {
              --display: flex;
              --flow: column;
              display: var(--display);
              flex-flow: var(--flow) nowrap;
              align-items: center;
              justify-content: space-between;
              gap: 0.5rem;

              @media (640px < width) {
                & {
                  --flow: column;
                }
              }

              svg {
                color: color-mix(in srgb, currentColor 60%, transparent);
              }

              input[type="date"] {
                -webkit-appearance: none; /* Remove arrow in chrome mobile */
                background: transparent;
                width: min-content;
                border: none;
                padding: 0;

                font-family: inherit;
                font-size: inherit;
                color: inherit;

                &:disabled {
                  /* Allow click on parent to toggle details open/close */
                  pointer-events: none;
                }
              }

              p {
                --margin: 0 2px; /* match input date */
                text-align: center;
                margin: var(--margin);
              }
            }

            &::-webkit-details-marker {
              display: none;
            }
          }

          [part="description"] {
            word-break: break-word;
          }

          [part="button"] {
            display: inline-block;
            border-radius: 2px;
            text-decoration: none;
            margin: 1rem 2px;
            cursor: pointer;
            transition-duration: 0.2s;
            padding: 1rem 1.5rem;
            height: 5rem;

            &:hover {
              background-color: color-mix(
                in srgb,
                var(--color, currentColor) 10%,
                transparent
              );
            }
          }
        }
      }

      /* css support warning */
      @supports not selector(&) {
        main::after {
          content: "üö® CSS anidado no soportado por el navegador.";
          display: block;
          color: red;
          font-size: 1.5rem;
          text-align: center;
        }
      }
    </style>
  </body>

  <script type="module">
    import { getSheetData } from "/get-gsheet-data.js";
    const eventsElement = document.getElementById("events");
    const fetchedEvents = await getSheetData();

    eventsElement.innerHTML = ""; /* Clear loading message */

    for (let event of fetchedEvents) {
      if (isOlderThanNow(event["Comienzo"])) {
        console.info("Omitting old event:", event["Comienzo"]);
        continue;
      }

      console.info("Event to display received:", event);

      const eventElement = document.createElement("event-entry");
      eventElement.data = enhanceEvent(event);
      eventsElement.appendChild(eventElement);
    }

    function isOlderThanNow(dateString) {
      if (!dateString) return true;
      // Parse the input date string
      const [datePart, timePart] = dateString.split(" ");
      const [day, month, year] = datePart.split("/");
      const [hours, minutes, seconds] = timePart.split(":");

      // Create a Date object from the parsed components
      // Note: months are 0-indexed in JavaScript Date
      const inputDate = new Date(year, month - 1, day, hours, minutes, seconds);

      // Get the current date and time
      const now = new Date();

      // Compare the dates
      return inputDate < now;
    }

    function enhanceEvent(event) {
      // Provide a image_url
      const imageIdRegexp = /id=([\d\w-]*)/gm;
      const imageIdMatch = imageIdRegexp.exec(event["Imagen"]);
      const fileId = imageIdMatch && imageIdMatch[1];
      if (fileId) {
        event.id = fileId;
        event.imageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w768`;
      }

      // Replace URLs in the content with anchor tags without query parameters
      if (event["Descripci√≥n"]) {
        const urlRegex =
          /(\b(?:https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;

        event["Descripci√≥n"] = event["Descripci√≥n"].replace(
          urlRegex,
          (match) => {
            // Create a URL object to easily manipulate the URL
            let url = new URL(match);
            // Remove the query parameters
            url.search = "";
            // Return the modified URL in an anchor tag
            return `<a href="${match}" target="_blank">${url.href}</a>`;
          }
        );
      }
      return event;
    }

    document.querySelectorAll("summary").forEach((summary) => {
      summary.addEventListener("click", (event) => {
        setTimeout(
          () =>
            summary.nextElementSibling.scrollIntoView({
              block: "nearest",
              behavior: "smooth",
            }),
          100
        );
      });
    });
  </script>
</html>
