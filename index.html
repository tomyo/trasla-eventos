<!DOCTYPE html>
<html lang="es-AR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#e6deca" />
    <meta name="color-scheme" content="light only" />

    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/icons/icon-512x512.png" />
    <link rel="apple-touch-icon" href="/assets/icons/apple-touch-icon.png" />

    <!-- START CONTENT_METADATA_BLOCK -->
    <title>La Agenda de Eventos de Traslasierra | Trasla Eventos</title>
    <link rel="alternate" type="application/ld+json" href="/events/schema.jsonld" />
    <link rel="canonical" property="og:url" href="https://eventos.trasla.com.ar" />
    <meta
      name="description"
      content="Descubr칤 eventos, ferias, talleres y conciertos en Traslasierra. La agenda cultural m치s completa del valle, actualizada cada d칤a en Trasla Eventos."
    />
    <meta property="og:title" content="La Agenda de Eventos de Traslasierra" />
    <meta
      property="og:description"
      content="Encontrate con lo que pasa en Traslasierra: ferias, m칰sica, talleres y encuentros culturales. Entr치 a Trasla Eventos y viv칤 el movimiento del valle."
    />
    <meta property="og:image" content="https://eventos.trasla.com.ar/assets/images/og-image-1200w-900h.avif" />
    <meta property="og:image:type" content="image/avif" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="900" />
    <meta property="og:image" content="https://eventos.trasla.com.ar/assets/images/og-image-1200w-900h.jpg" />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="900" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://eventos.trasla.com.ar" />

    <meta property="og:site_name" content="TRASLA EVENTOS" />
    <meta property="og:locale" content="es-AR" />

    <!-- END CONTENT_METADATA_BLOCK -->

    <script>
      (function getOutOfInAppBrowser() {
        // 1. In-App Browser Detection
        function isInAppBrowser() {
          const ua = navigator.userAgent || navigator.vendor || window.opera;
          return /instagram/i.test(ua) || /fban|fbav/i.test(ua) || /wv/i.test(ua);
        }

        function getSourceFromReferrer(referrer) {
          if (!referrer) return "direct";
          if (referrer.includes("instagram.com")) return "instagram";
          if (referrer.includes("facebook.com") || referrer.includes("fb.com")) return "facebook";
          if (referrer.includes("whatsapp.com")) return "whatsapp";
          if (referrer.includes("t.co") || referrer.includes("twitter.com") || referrer.includes("x.com"))
            return "twitter";
          return "unknown";
        }

        // 2. Redirection Logic
        function redirectToExternalBrowser() {
          const url = new URL(location.href);
          const ua = navigator.userAgent;
          const isAndroid = /android/i.test(ua);
          const isIOS = /iphone|ipad|ipod/i.test(ua);

          url.searchParams.set("utm_referrer", document.referrer || "none");
          url.searchParams.set("utm_source", getSourceFromReferrer(document.referrer));
          url.searchParams.set("utm_medium", isAndroid ? "android" : isIOS ? "ios" : "unknown");
          url.searchParams.set("utm_campaign", "external_browser");
          url.searchParams.set("utm_content", "escape_in_app_browser");

          if (isAndroid) {
            // Generic Intent URI, so hopefuly pwa will open if installed, or default browser otherwise.
            const intentUri = `intent://${url.toString().replace(/^https?:\/\//, "")}#Intent;scheme=https;end`;
            window.location.href = intentUri;

            // const chromeIntentUri = `intent://${url
            //   .toString()
            //   .replace(/^https?:\/\//, "")}#Intent;scheme=https;package=com.android.chrome;end`;
            // window.location.href = chromeIntentUri;
          } else if (isIOS) {
            // Try to open in Chrome (if installed)
            const chromeUrl = `googlechrome://x-callback-url/open/?url=${encodeURIComponent(url.toString())}`;
            window.location.href = chromeUrl;
          }

          // Fallback when we are still stuck in the in-app browser after 2 seconds
          setTimeout(() => {
            if (document.visibilityState === "visible") {
              window.open(url, "_blank", "noopener,noreferrer");
            }
          }, 2000);
        }

        // 3. Execution
        if (isInAppBrowser()) {
          // Delay to make sure WebView has fully initialized before attempting redirect.
          // 100ms is a safe value for most WebViews.
          setTimeout(redirectToExternalBrowser, 100);
        }
      })();
    </script>

    <!-- Google Tag Manager -->
    <!-- Speed up GTM -->
    <link rel="preconnect" href="https://www.googletagmanager.com" />
    <script>
      (function (w, d, s, l, i) {
        // Your localhost check is good, keep it.
        if (location.origin.includes("localhost")) return;
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-MZ99GDSV");
    </script>
    <!-- End Google Tag Manager -->

    <link rel="modulepreload" href="/lib/utils.js" />
    <link rel="modulepreload" href="/components/fixed-background.js" />
    <link rel="modulepreload" href="/components/share-url/share-url.js" />
    <link rel="modulepreload" href="/components/install-button/install-button.js" />
    <link rel="modulepreload" href="/components/horizontal-carousel/horizontal-carousel.js" />
    <link rel="preload" href="/components/horizontal-carousel/horizontal-carousel.css" as="style" />
    <link rel="preload" href="/components/event-entry.css" as="style" />
    <!-- Preconnect to Google Sheets for faster event data fetching -->
    <link rel="preconnect" href="https://docs.google.com" />

    <script type="module" src="/components/event-entry.js"></script>
    <script type="module" src="/components/events-filter.js"></script>
    <script type="module" src="/components/site-header.js"></script>
    <script type="module" src="/components/fixed-background.js"></script>
    <script type="module" src="/components/hero-section.js"></script>
    <script type="module" src="/components/install-button/install-button.js"></script>

    <link rel="manifest" href="/manifest.json" />
    <link rel="stylesheet" href="/base.css" />
  </head>
  <body>
    <script src="/components/today-date-picker.js" type="module"></script>
    <fixed-background></fixed-background>
    <site-header></site-header>
    <hero-section>
      <!-- <h1 slot="title">La agenda de eventos de Traslasierra</h1> -->
      <h1 slot="title">
        La Agenda de eventos de <br /><span style="font-size: larger; font-weight: bold">Traslasierra</span>
      </h1>
    </hero-section>
    <seo-block>
      <h2>쯈u칠 hacer en Traslasierra?</h2>
      <p>
        Encontr치 informaci칩n de las ferias, conciertos, talleres y eventos culturales en Traslasierra. Actualizado cada
        d칤a con las mejores propuestas del Valle.
      </p>
      <p>
        Encontr치 qu칠 hacer hoy, este fin de semana o en tu pr칩xima visita. Eventos en Mina Clavero, Nono, Villa de Las
        Rosas, Merlo y todas las localidades de Traslasierra.
      </p>
    </seo-block>
    <main>
      <section id="eventos" class="mountains-top" aria-label="Eventos">
        <events-filter id="eventsFilter">
          <form>
            <h2 class="form-filters-as-heading">
              <span>Eventos en</span>
              <select-locality>
                <select name="locality" aria-label="Localidad" multiple>
                  <option value="" selected>TRASLASIERRA</option>
                  <option value="Arroyo de Los Patos">ARROYO DE LOS PATOS</option>
                  <option value="Boca del Rio">BOCA DEL RIO</option>
                  <option value="Dique de La Vi침a">DIQUE DE LA VI칌A</option>
                  <option value="El Pueblito">EL PUEBLITO</option>
                  <option value="La Paz">LA PAZ</option>
                  <option value="La Poblaci칩n">LA POBLACI칍N</option>
                  <option value="Las Calles">LAS CALLES</option>
                  <option value="Las Chacras">LAS CHACRAS</option>
                  <option value="Las Rabonas">LAS RABONAS</option>
                  <option value="Las Tapias">LAS TAPIAS</option>
                  <option value="Los Hornillos">LOS HORNILLOS</option>
                  <option value="Los Molles">LOS MOLLES</option>
                  <option value="Los Pozos">LOS POZOS</option>
                  <option value="Luyaba">LUYABA</option>
                  <option value="Mina Clavero">MINA CLAVERO</option>
                  <option value="Nono">NONO</option>
                  <option value="Panaholma">PANAHOLMA</option>
                  <option value="Piedra Pintada">PIEDRA PINTADA</option>
                  <option value="Quebracho Ladeado">QUEBRACHO LADEADO</option>
                  <option value="San Huberto">SAN HUBERTO</option>
                  <option value="San Javier">SAN JAVIER</option>
                  <option value="San Lorenzo">SAN LORENZO</option>
                  <option value="San Pedro">SAN PEDRO</option>
                  <option value="Travesia">TRAVESIA</option>
                  <option value="Villa Cura Brochero">VILLA CURA BROCHERO</option>
                  <option value="Villa de Merlo">VILLA DE MERLO</option>
                  <option value="Villa de Las Rosas">VILLA DE LAS ROSAS</option>
                  <option value="Villa Dolores">VILLA DOLORES</option>
                  <option value="Yacanto">YACANTO</option>
                  <option value="Virtual">VIRTUAL</option>
                </select>

                <script>
                  // Scroll to first option (Traslasierra) when no options are selected.

                  const select = document.querySelector("select-locality select");
                  function scrollSelectToTopIfNoOptionSelected() {
                    if (select.selectedOptions.length == 0) {
                      select.scrollTo(0, 0);
                    }
                  }
                  select.addEventListener("blur", (event) => {
                    scrollSelectToTopIfNoOptionSelected();
                  });
                </script>
              </select-locality>
              <span data-nosnippet>A Partir de<span id="hideOnToday">l</span></span>
              <today-date-picker>
                <input type="date" name="startDate" aria-label="Fecha de inicio" />

                <style>
                  form:has(today-date-picker[today]) #hideOnToday {
                    display: none;
                  }

                  today-date-picker {
                    position: relative;

                    > * {
                      width: 100%;
                    }

                    &:not(:focus-within)[today] {
                      &::before {
                        content: "Hoy";
                        position: absolute;
                        inset: 0;
                        display: grid;
                        place-content: center;
                        background-color: var(--background-color-darker);
                        z-index: 1;
                        pointer-events: none; /* Allow clicks through */
                      }

                      &:hover::before {
                        content: none;
                      }

                      &::after {
                        content: "";
                        position: absolute;
                        top: 50%;
                        right: 0.5rem;
                        width: 0;
                        height: 0;
                        border-left: 0.25rem solid transparent;
                        border-right: 0.25rem solid transparent;
                        border-top: 0.25rem solid gray;
                        margin-top: -0.1rem;
                        z-index: 1;
                      }
                    }
                  }
                </style>
              </today-date-picker>
            </h2>

            <input name="endDate" type="date" hidden />
            <label hidden>
              <input checked type="checkbox" name="activities[]" value="Evento" />
              Eventos
            </label>
            <label hidden>
              <input checked type="checkbox" name="activities[]" value="Taller" />
              Talleres
            </label>
            <label hidden> 游댍 </label>
            <input hidden type="search" name="search" placeholder=" Palabras claves" style="width: 100%" />
          </form>
          <event-entries>
            <!-- SSR (via [{slug|locality}].js) replaces this element (via regex 游땸) with pre-filled <event-entry>'s -->
            <p style="text-align: center">췅 췅 췅</p>
          </event-entries>
          <button id="viewMoreEvents" onclick="eventsFilter.showMore();">
            <style>
              #viewMoreEvents {
                display: flex;
                flex-flow: row nowrap;
                background-color: var(--color-green) !important;
                align-items: center;
                justify-content: initial;
                color: var(--color-light);
                gap: 1rem;
                font-size: 0.66rem;
                font-weight: 600;
                width: 12rem;
                height: 3rem;
                margin-inline: auto;
              }

              events-filter:not(:has(event-entry)) #viewMoreEvents {
                display: none;
              }

              events-filter[all-shown] #viewMoreEvents {
                display: none;
              }
            </style>
            <svg-mask
              style="--src: url('/assets/icons/loica.svg'); --color: var(--color-light); width: 30px; height: 18px"
            >
            </svg-mask>
            Ver m치s eventos
          </button>
        </events-filter>
      </section>
      <section id="about">
        <style>
          #about {
            display: flex;
            flex-flow: column nowrap;
            align-items: center;
            text-align: center;
          }
        </style>
        <img src="/assets/images/mountain.svg" height="100" alt="" />
      </section>
    </main>
    <script type="module" src="/components/site-footer.js"></script>
    <site-footer></site-footer>

    <style>
      section#eventos {
        & events-filter {
          display: flex;
          flex-flow: column;
          gap: 3rem;
          text-wrap: balance;
          align-items: center;

          & form {
            --input-height: 2.3rem;
            display: var(--form-display, flex);
            flex-flow: column nowrap;
            align-items: stretch;
            text-align: center;
            gap: 0.66rem;
            width: 13rem;

            & .form-filters-as-heading {
              margin: 0;
              display: inherit;
              flex-flow: inherit;
              align-items: inherit;
              gap: inherit;
              font-weight: 1.2rem;
              letter-spacing: initial;

              & :not(span) {
                font-weight: normal;
                font-size: initial;
              }
            }

            & button,
            & select,
            & input {
              padding: 0.5rem;
              text-align: inherit;
              height: var(--input-height);
              min-height: max-content;
              font: inherit;
            }
          }

          select-locality {
            position: relative;
            --down-arrow-content: "";
            --options-to-show: 1;

            @media (hover: hover) {
              --options-to-show: 4;
              --down-arrow-content: none;
            }

            @supports (-moz-appearance: none) {
              --options-to-show: 4; /* Firefox on mobile shows a scrollable <select> */
              --down-arrow-content: none;
            }

            select {
              padding: 0;
              height: calc(var(--input-height) * var(--options-to-show));

              /* &[multiple]:has(option:checked ~ option:checked) {
                height: calc(var(--input-height) * var(--options-to-show));
              } */

              option {
                height: var(--input-height);
                align-content: center;
              }
            }

            &::after {
              content: var(--down-arrow-content);
              position: absolute;
              top: 50%;
              right: 0.5rem;
              width: 0;
              height: 0;
              border-left: 0.25rem solid transparent;
              border-right: 0.25rem solid transparent;
              border-top: 0.25rem solid gray;
              margin-top: -0.1rem;
            }

            & > select {
              /* Cross browser styling */
              appearance: none;
              border-radius: 0;
              text-align: center !important;
              width: 100%;
              color: currentColor;
            }
          }

          & > *:not(event-entries) {
            text-transform: uppercase;
          }
        }
        &:not(:has(events-filter)) {
          /* Only one event is shown */
          --form-display: none;
          --summary-display: none;
        }

        & event-entries {
          display: flex;
          flex-flow: column nowrap;
          gap: 2rem;
          align-items: center;

          > div {
            display: none;
            flex-flow: row wrap;
            gap: 2rem;
            justify-content: center;

            &:has(event-entry:not([excluded]):not([hidden])) {
              display: flex;
            }
          }

          & time {
            display: none; /* Shown per [date] via js custom css */
            font-family: var(--font-family-heading);
            text-align: center;
            position: sticky;
            top: 1rem;
            width: 17ch;
            color: var(--color-light);
            font-size: 1rem;
            font-weight: 500;
            padding: 0.3rem;
            z-index: 1;

            &::before {
              content: "";
              inset: 0;
              width: 100%;
              position: absolute;
              z-index: -1;
              background-color: var(--color-red);
              border-radius: calc(var(--border-radius) / 2);
            }
          }
        }
      }
    </style>

    <script type="module">
      import { getGoogleSheetEvents } from "/lib/get-events.js";
      import { escapeHtml, slugify, isDateToday, formatLocalDate, eventsToSchemaOrgItemList } from "/lib/utils.js";

      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const eventsElement = document.querySelector("event-entries");

      /**
       * Injects a JSON-LD script tag with schema.org data for the given events.
       * @property {EventResponse[]} events
       */
      async function injectSchemaOrgJson(events) {
        const SCRIPT_ID = "events-schema-org";
        try {
          let script = document.getElementById(SCRIPT_ID);
          if (!script) {
            script = document.createElement("script");
            script.id = SCRIPT_ID;
            script.type = "application/ld+json";
            document.head.appendChild(script);
          }
          script.textContent = JSON.stringify(eventsToSchemaOrgItemList(events, location.origin));
        } catch (err) {
          console.warn(err);
        }
      }

      /**
       * @param {eventData} event
       * @returns {number}
       */
      function getSortOrder(event) {
        const date = new Date(event.startsAt);
        const items = [date.getFullYear() - 2000, date.getMonth(), date.getDate(), date.getHours(), date.getMinutes()];
        return Number(items.map((t) => t.toString().padStart(2, "0")).join(""));
      }

      /**
       * @param {EventResponse} event
       */
      function appendEvent(eventData, { open, containerSelector = "event-entries" } = {}) {
        const eventElement = document.createElement("event-entry");
        const container = document.querySelector(containerSelector);

        for (const [key, value] of Object.entries(eventData)) {
          // if (!Object.hasOwnProperty.call(eventData, key)) continue;
          if (!value) continue;
          eventElement.dataset[key] = value;
        }
        // Add date attribute to handle <time> title hidden logic
        eventElement.setAttribute("date", formatLocalDate(new Date(eventElement.dataset.startsAt)));
        eventElement.classList.add("card");

        if (open) {
          eventElement.open = true;
        }
        container.appendChild(eventElement);
      }

      async function fetchAndShowEvents() {
        let upcomingEvents = (await getGoogleSheetEvents()).sort((a, b) => {
          return getSortOrder(a) - getSortOrder(b);
        });

        // Check if we are in /lugar/locality-slug path to only include events on that locality
        if (location.pathname.includes("/lugar/")) {
          const localitySlug = location.pathname.replace(/\/lugar\/(.*)\//, "$1").toLowerCase();
          upcomingEvents = upcomingEvents.filter((event) => slugify(event.locality) == localitySlug);
        }
        renderEvents(upcomingEvents);
        eventsFilter.updateUI();

        injectSchemaOrgJson(upcomingEvents);
      }

      /**
       * @param {Date} date
       * @returns {string}
       */
      function formatDateTitle(date) {
        return date
          .toLocaleDateString("es-AR", {
            weekday: "long",
            day: "2-digit",
            month: "2-digit",
          })
          .toUpperCase();
      }

      function addTimeEntry(eventDate, { prepend, containerSelector = "event-entries" } = {}) {
        const container = document.querySelector(containerSelector);
        const dateTitle = document.createElement("time");
        const dateString = formatLocalDate(eventDate);
        dateTitle.setAttribute("date", dateString);
        dateTitle.textContent = formatDateTitle(eventDate);

        if (prepend) {
          dateTitle.style = "display: revert;"; // improve by adding css in SSR
          container.prepend(dateTitle);
          return dateTitle;
        }
        return container.appendChild(dateTitle);
      }

      async function renderEvents(events) {
        // Fuzzy search
        const url = new URL(location);
        const query = url.searchParams.get("q") || "";
        let eventsToAppend = [];
        eventsElement.innerHTML = ""; /* Clear loading message */

        if (query) {
          const { fuzzySearch } = await import("/lib/fuzzy-search-events.js");

          const searchResults = fuzzySearch(events, query);
          if (!searchResults) {
            eventsElement.innerHTML = /*html*/ `<p>No encontramos resultados con: ${query}</p>`; /* Clear loading message */
            return;
          }
          return appendEvent(searchResults[0].item, { open: true });
        }

        // Add date titles between events
        const dates = [];
        let lastDate = today;
        let shouldAddTime = true;
        for (const event of events) {
          lastDate.setHours(23, 59, 59, 999);
          const eventDate = new Date(event.startsAt);

          if (lastDate < eventDate) {
            shouldAddTime = true;
          }
          if (shouldAddTime) {
            addTimeEntry(eventDate);
            dates.push(formatLocalDate(eventDate));
            lastDate = eventDate;
            shouldAddTime = false;
            // Add div wrapper for events of the same date
            const div = document.createElement("div");
            eventsElement.appendChild(div);
          }
          appendEvent(event, { containerSelector: "event-entries>div:last-of-type" });
        }

        const style = document.createElement("style");
        style.textContent = dates
          .map(
            (date) => /*css*/ `
              time[date="${date}"]:has(~ div>event-entry[date="${date}"]:not([excluded]):not([hidden])) {
                display: revert !important;
              }
            `
          )
          .join("\n");
        eventsElement.appendChild(style);
      }

      // RUN

      // START: Service Worker
      /**
       * @type {ServiceWorkerRegistration}
       */
      let swRegistration;

      if ("serviceWorker" in navigator) {
        try {
          swRegistration = await navigator.serviceWorker.register("/service-worker.js", { type: "module" });
          console.log("Service Worker registered:", swRegistration);
        } catch (error) {
          console.log("Service Worker registration failed:", error);
        }
      }

      // END: Service Worker

      // Get events

      if (!document.querySelector("event-entry")) {
        // Normal flow when requesting /index.html
        fetchAndShowEvents();
      } else {
        // SSR prerendered <event-entry> elements into the dom (v칤a [slug].js)

        // Add missing sticky <time> entry before first event, since that's how we show the event's date now.
        addTimeEntry(new Date(document.querySelector("event-entry").dataset.startsAt), { prepend: true });

        // Scroll into event's section
        const focusElement = () => document.querySelector("section#eventos").scrollIntoView({ behavior: "smooth" });
        if (document.readyState === "complete") {
          focusElement();
        } else {
          window.addEventListener("load", focusElement);
        }
      }

      // UX improvements when seeing a locality page (/lugar/locality-slug)
      if (location.pathname.includes("/lugar/")) {
        const linkToHighlight = document.querySelector(`[href="${location.pathname}"]`);
        if (linkToHighlight) linkToHighlight.style.fontWeight = "bolder";
        const localitySlug = location.pathname.replace(/\/lugar\/(.*)\//, "$1");
        // Highlight selected locality on dropdown menu
        for (const option of document.querySelectorAll("[name='locality'] option")) {
          if (slugify(option.value) == localitySlug) {
            option.selected = true;
            break;
          }
          option.selected = false;
          option.hidden = true;
        }
        const select = document.querySelector("[name='locality']");
        select.disabled = true;
        select.style.setProperty("--options-to-show", "1");
      }

      //
    </script>

    <!-- START LEGACY BROWSERS CSS SUPPORT -->
    <noscript>
      <link rel="stylesheet" href="./legacy.css" />
    </noscript>
    <script>
      // Legacy browsers css support
      // Generated by scripts/build-legacy-css.js on `make legacy-css` or 'npm run build:legacy-css'
      if (!CSS.supports("selector(&)") || !CSS.supports("selector(has)")) {
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = "./legacy.css";
        document.body.appendChild(link);
      }
    </script>
    <!-- END LEGACY BROWSERS CSS SUPPORT -->
  </body>
</html>
