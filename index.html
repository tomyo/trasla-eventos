<!DOCTYPE html>
<html lang="es-AR">
  <head>
    <meta name="theme-color" content="#303030" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eventos en Trasla</title>
    <meta
      name="description"
      content="Eventos en Traslasierra, C√≥rdoba, Argentina"
    />
    <script type="module" src="/components/event-entry.js"></script>
    <script type="module" src="/components/theme-toggle.js"></script>
    <link rel="manifest" href="manifest.json" />

    <style>
      /* Reset */
      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        font-size: 100%;
        line-height: 1.25;
        scroll-behavior: smooth;
      }

      details summary {
        cursor: pointer;
      }

      details summary > * {
        display: inline;
      }

      /* Global styles */

      /* <theme> */
      [data-theme="üåë"] {
        --color-scheme: dark;
        color-scheme: dark;
      }

      [data-theme="‚òÄÔ∏è"] {
        --color-scheme: light;
        color-scheme: light;
      }

      :root {
        --color-light: #fafafa;
        --color-dark: #222222;
        --color: var(--color-dark);
        --background-color: var(--color-light);
        color-scheme: var(--color-scheme, dark light);

        &[data-theme="üåë"] {
          color-scheme: dark;

          --color: var(--color-light);
          --background-color: var(--color-dark);
        }
      }
      /* </theme> */

      @font-face {
        font-family: "DM Sans";
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url("/assets/fonts/DM-Sans.woff2") format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

      body {
        font-family:"DM Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
        background-color: var(--background-color);
        color: var(--color);

        transition: all ease-in-out 0.2s;
      }

      a {
        color: inherit;
      }

      button,
      .button {
        outline: 1px solid currentColor;
        text-decoration: none;
        padding: .7rem 1.5rem;
        border-radius: 2rem;
        text-transform: uppercase;

        &:hover, &:focus-within {
          background-color: color-mix(
          in srgb,
          var(--color, currentColor) 10%,
          transparent
        );
      }
    </style>
  </head>
  <body>
    <header>
      <theme-toggle title="Alternar color del tema">
        <img
          src="/assets/images/theme-toggle.png"
          width="25"
          height="25"
          alt="Sol/Luna: Alternar color del tema"
        />
      </theme-toggle>
      <a href="/" style="text-decoration: none">
        <h1>EVENTOS.TRASLA</h1>
      </a>
    </header>
    <main>
      <section id="actions">
        <a
          id="addEvent"
          class="button"
          target="_blank"
          title="Publicar nuevo evento"
          href="https://docs.google.com/forms/d/e/1FAIpQLSdxTx6-LxssWkFlbPqFF6u-QZrNpgC-RJpm9eNweFHXNY8bVA/viewform?usp=sf_link"
        >
          Publicar evento
        </a>
        <a class="button" title="Ver eventos" href="#events">Ver eventos</a>
      </section>
      <section id="events">
        <p style="text-align: center">¬∑ ¬∑ ¬∑</p>
      </section>
    </main>

    <style>
      :root[data-theme="üåë"] {
        #logo,
        theme-toggle {
          filter: invert(1);
        }
      }

      header {
        text-align: center;
        padding: 2rem; /* margins adds scroll */
        padding-top: 3.3rem;

        theme-toggle {
          position: absolute;
          cursor: pointer;
          top: max(1.5rem, 5vmin);
          left: max(1.5rem, 7vmin);
        }
        #addEvent {
          position: absolute;
          top: max(1.5rem, 5vmin);
          right: max(1.5rem, 7vmin);
          width: min-content;
          text-decoration: none;
          color: var(--color, currentColor);
        }

        h1 {
          font-weight: 300;
          margin-bottom: 0.4rem;
          letter-spacing: 1px;
        }
      }

      main {
        max-width: 37ch;
        margin: auto;
      }

      #actions {
        display: grid;
        justify-content: center;
        gap: 1rem;
        text-align: center;
        margin-block: 2rem;
      }

      #events {
        display: flex;
        flex-flow: column nowrap;
        max-width: 90ch;
        margin-inline: auto;
        gap: 1rem;

        event-entry {
          --visible-elements: 1;
          --padding: 4.5rem 1rem;
          display: block;
          margin: 2rem 2rem;
          border-radius: 10px;
          min-width: min-content;
          text-align: center;
          background-image: linear-gradient(
            to bottom,
            transparent,
            color-mix(in srgb, var(--color, currentcolor) 7%, transparent)
          );
          padding: 1.5rem;
          background-color: color-mix(
            in srgb,
            var(--color, currentcolor) 7%,
            var(--background-color, currentcolor)
          );

          .event-image {
            width: 100%;
            height: auto;
            min-height: 15rem;
            object-fit: contain;
            cursor: pointer;
            border-radius: 10px;
          }

          .info {
            display: grid;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1em;

            > * {
              margin: none;
            }

            .location,
            .datetime {
              display: flex;
              gap: 0.5rem;
            }

            svg {
              color: color-mix(in srgb, currentColor 60%, transparent);
            }

            input[type="date"] {
              -webkit-appearance: none; /* Remove arrow in chrome mobile */
              background: transparent;
              width: min-content;
              border: none;
              padding: 0;

              font-family: inherit;
              font-size: inherit;
              color: inherit;

              &:disabled {
                /* Allow click on parent to toggle details open/close */
                pointer-events: none;
              }
            }

            p {
              --margin: 0 2px; /* match input date */
              text-align: center;
              margin: var(--margin);
            }
          }

          summary {
            align-items: center;
            cursor: pointer;
            padding-block: 0.5rem;
            align-items: start;
            position: relative;

            &::-webkit-details-marker {
              display: none;
            }
          }

          [part="description"] {
            word-break: break-word;
            text-wrap: balance;
            text-align: start;
            margin-inline: 1rem;
          }

          [part="buttons"] {
            display: flex;
            justify-content: space-evenly;
            margin-block: 1rem;
          }

          [part="button"] {
            display: inline-block;
            border-radius: 2px;
            text-decoration: none;
            cursor: pointer;
            transition-duration: 0.2s;
            padding: 0.5rem;
            height: 2.5rem;
            border: none;
            background: none;
            outline: none;

            &:hover {
              background-color: color-mix(
                in srgb,
                var(--color, currentColor) 10%,
                transparent
              );
            }
          }
        }
      }

      /* css support warning */
      @supports not selector(&) {
        main::after {
          content: "üö® Este sitio por ahora requiere de una versi√≥n mas actualizada de tu navegador...";
          display: block;
          color: red;
          font-size: 1.5rem;
          text-align: center;
        }
      }
    </style>

    <script type="module">
      import { getSheetData } from "/lib/get-gsheet-data.js";
      import {
        escapeHtml,
        slugify,
        encodeForDataset,
        formatEventResponse,
        parseEventResponseDateString,
      } from "/lib/utils.js";

      function isDateToday(date) {
        return (
          date.getDate() === now.getDate() &&
          date.getMonth() === now.getMonth() &&
          date.getFullYear() === now.getFullYear()
        );
      }

      /**
       *
       * @param {Date} date
       * @returns
       */
      function getSortOrder(date) {
        const items = [
          date.getFullYear(),
          date.getMonth(),
          date.getDate(),
          date.getHours(),
        ];
        return items.map((t) => t.toString().padStart(2, "0")).join("");
      }

      function appendEvents(events) {
        for (const event of events) {
          const eventDate = parseEventResponseDateString(event["Comienzo"]);
          if (!isDateToday(eventDate) && eventDate < now) {
            continue;
          }

          appendEvent(event);
        }
      }

      /**
       * @param {EventResponse} event
       */
      function appendEvent(eventResponse, { open, order } = {}) {
        const eventData = formatEventResponse(eventResponse);
        const eventElement = document.createElement("event-entry");

        if (!order) {
          order = getSortOrder(new Date(eventData["start-date"]));
        }
        for (const [key, value] of Object.entries(eventData)) {
          if (!Object.hasOwnProperty.call(eventData, key)) continue;
          if (typeof value !== "string")
            console.error(`Value for key ${key} is not a string: ${value}`);

          eventElement.setAttribute(`data-${key}`, escapeHtml(value));
        }

        if (open) {
          eventElement.open = true;
        }
        eventElement.style = `order: ${order}`;
        eventsElement.appendChild(eventElement);
      }

      async function showEvents(events) {
        // Fuzzy search
        const url = new URL(location);
        const query = url.searchParams.get("q") || "";
        let eventsToAppend = [];
        eventsElement.innerHTML = ""; /* Clear loading message */

        if (query) {
          const { fuzzySearch } = await import("/lib/fuzzy-search-events.js");

          const searchResults = fuzzySearch(events, query);
          if (!searchResults) {
            eventsElement.innerHTML = /*html*/ `<p>No encontramos resultados con: ${query}</p>`; /* Clear loading message */
            return;
          }
          return appendEvent(searchResults[0].item, { open: true });
        }

        appendEvents(events);
      }

      // RUN

      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const eventsElement = document.getElementById("events");

      // Get all events and drop old ones
      const upcomingEvents = (await getSheetData()).filter((event) => {
        return today <= parseEventResponseDateString(event["Comienzo"]);
      });

      if (!document.querySelector("#events event-entry")) {
        showEvents(upcomingEvents);
      }
    </script>
  </body>
</html>
