<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trasla Eventos: Carga rápida de eventos de Instagram</title>
    <script type="module" src="/components/event-entry.js"></script>
  </head>
  <body>
    <h1>Cargar rápida de evento de Instagram</h1>
    <form
      action="https://hook.us2.make.com/810vwbmrsrbh6yi6rqzvp6ak5au7dtfc"
      method="post"
      enctype="multipart/form-data"
    >
      <label for="url">Link al post (videos o historias no soportadas)</label>
      <input type="url" id="url" name="url" required placeholder="https://www.instagram.com/p/DIOnBf5RzAA/" />

      <button type="submit" name="submit">Cargar evento</button>

      <output name="output">
        <event-entry></event-entry>
      </output>
    </form>

    <style>
      form {
        display: grid;
        gap: 1rem;
      }
    </style>
    <script type="module">
      const SHARE_TARGET_ACTION = "/share-target"; // Also used as the cache key for the shared data
      const form = document.querySelector("form");
      const cache = await caches.open(SHARE_TARGET_ACTION);

      async function hydrateWithCachedData() {
        // Hydrate texts
        for (const input of document.querySelectorAll("input")) {
          const key = input.name;
          const response = await cache.match(`/${key}`);

          if (!response || !response.ok) {
            console.info(`Cache miss for key ${key}`);
            continue;
          }
          const contentType = response.headers.get("content-type");
          if (!contentType?.includes("text")) {
            console.warn(`Content type mismatch for key ${key}: expected text but got ${contentType}`);
            continue;
          }
          console.info(`Hydrating ${key} from cache`);
          input.value = await response.text();
        }
      }

      hydrateWithCachedData();

      form.addEventListener("submit", async (event) => {
        event.preventDefault(); // Prevent default submission
        form.elements["submit"].disabled = true;
        form.elements["output"].textContent = "Procesando link del evento ...";

        const response = await fetch(form.action, {
          method: form.method,
          body: new FormData(form),
        });

        if (!response || !response.ok) {
          alert(response.statusText);
          return;
        }
        const result = await response.json();
        if (result.alreadyExists) {
          alert(`El evento ya fue cargado anteriormente con el ID ${result.id}.`);
        }

        form.elements["output"].textContent = "Procesando info del evento...";

        if (!result.id) {
          alert(`Hubo un error al cargar el evento. Por favor intenta nuevamente más tarde. ${result}`);
          throw new Error(`No id returned in the response`, result);
        }

        let eventData = {};
        const queryParameters = `endpoint=getDraftEventById&id=${result.id}`;
        const getDraftEventByIdURL = `https://script.google.com/macros/s/AKfycbx-aF03sO-JizuijiMY1tu5v0GXhzH08GUtkUy0tegwzB8LLQ-VwzD7YEQ-vK1YEcK_/exec?${queryParameters}`;
        do {
          const response = await fetch(getDraftEventByIdURL);
          form.elements["output"].textContent = "Cargando info del evento...";

          if (!response.ok) throw new Error(response.statusText);
          const jsonResponse = await response.json();
          if (!jsonResponse.success) throw new Error(jsonResponse.message);
          eventData = jsonResponse.data;
          console.log(`Event data received: `, eventData);
          // Add 1 second delay to refresh data
          if (eventData.slug) continue;

          await new Promise((resolve) => setTimeout(resolve, 1000));
          console.log("Refreshing eventData, not slug found yet...");
        } while (!eventData.slug);

        // const eventEntry = document.querySelector("event-entry");
        // for (const [key, value] of Object.entries(eventData)) {
        //   if (!key && !value) continue; // Skip empty values
        //   eventEntry.dataset[key] = value;
        // }

        cache.delete("/url");
        form.reset();

        //redirect to event page
        window.location.href = `${window.location.origin}/${eventData.slug}`;
      });
    </script>
  </body>
</html>
